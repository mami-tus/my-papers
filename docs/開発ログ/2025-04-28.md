# 2025-04-28 pnpm への移行とモノレポ構造の整理

## 実装内容

- pnpm への移行とモノレポ構成の整備

  ```bash
  # プロジェクトルートでpnpmを初期化
  pnpm init
  ```

- フロントエンドのセットアップ（apps/frontend に配置）

  ```bash
  # Viteプロジェクトをフロントエンド用に作成
  pnpm create vite ./apps/frontend --template react-ts

  # フロントエンドディレクトリで依存関係をインストール
  cd ./apps/frontend
  pnpm i
  ```

- バックエンドのセットアップ（packages/api に配置）

  ```bash
  # Honoプロジェクトをバックエンド用に作成
  pnpm create hono ./packages/api --template cloudflare-workers

  # データベース関連パッケージの追加
  pnpm add kysely kysely-d1
  ```

## 問題点と解決策

### Cloudflare 環境での実行環境の違い

- **問題**: bun と Cloudflare Workers の実行環境の差異

  - bun はローカルで直接実行可能だが、Cloudflare Workers は V8 Isolate ベースの特殊な環境
  - ローカル開発と本番環境でランタイムの一貫性がない

- **解決策**: pnpm を採用
  - Cloudflare のツール (Wrangler) との連携実績が豊富
  - モノレポ構成での依存関係管理が厳密で安定している

### パッケージマネージャの選定基準

- **問題**: 開発速度と安定性のトレードオフ

  - bun は高速だが Cloudflare 環境との連携は比較的新しい
  - 本番環境でのデプロイと開発環境での一貫性を確保したい

- **解決策**: 安定志向の選択肢として pnpm を選定
  - エコシステムとの連携実績が豊富
  - モノレポ構成での依存関係管理が堅牢
  - ドキュメントやコミュニティの知見が充実

### モノレポ構造の設計

- **問題**: アプリケーションと共有パッケージの適切な配置

  - フロントエンドとバックエンドの関係性をディレクトリ構造に反映させたい

- **解決策**: 役割に基づくディレクトリ構成
  - `apps/`: エンドユーザー向けアプリケーション（frontend）
  - `packages/`: 共有ライブラリや API（api）

## 学んだこと・メモ

- pnpm の長所:

  - Cloudflare のツール (Wrangler) やデプロイプロセスとの連携実績が長い
  - ドキュメントやコミュニティの情報が豊富
  - 堅牢なモノレポ機能と厳密な依存関係管理

- bun と Cloudflare の関係:

  - bun は開発ツールとして使用可能だが、本番環境では Cloudflare 独自のランタイム上で実行される
  - 開発と本番の環境差を小さくするためには、より実績のあるツールチェーンが安全

- Cloudflare Workers の特性:

  - 「サーバーレス」の「エッジコンピューティング」環境
  - 通常の OS ではなく V8 Isolate という特殊な軽量 JavaScript 実行環境でコードが動作
  - ビルド時に互換性のある形式に変換されることを理解することが重要

- モノレポ構造の利点:
  - フロントエンド・バックエンドの明確な分離
  - 共通の依存関係や型定義の共有が容易
  - 各プロジェクトの独立性を保ちつつ、全体をまとめて管理できる
